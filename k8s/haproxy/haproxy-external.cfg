# HAProxy Configuration for API Load Balancing
# This configuration shows how external HAProxy should be configured
# to load balance between the two API servers

global
    daemon
    maxconn 4096
    log stdout local0

defaults
    mode http
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    option httplog
    option dontlognull
    option forwardfor

# Frontend for API requests (port 8888)
frontend web_front
    bind *:8888
    mode http
    
    # Health check endpoint
    acl is_health path_beg /health
    use_backend health_check if is_health
    
    # Default backend for all API requests
    default_backend api_servers

# Backend with the two API servers
backend api_servers
    mode http
    balance roundrobin
    
    # Health check configuration
    option httpchk GET /health
    http-check expect status 200
    
    # Primary API server
    server primary_api 43.252.9.155:8000 check weight 100
    
    # Backup API server (will be used when primary fails)
    server backup_api 43.252.9.157:8000 check weight 100 backup

# Health check backend
backend health_check
    mode http
    http-request return status 200 content-type text/plain string "HAProxy Healthy"

# Stats interface (optional)
frontend stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 10s
    stats show-legends
